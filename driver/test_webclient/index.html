<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Test Webclient</title>
    <style>
      body {
        display: grid;
        gap: 1em;
        grid-template-columns: repeat(3, 1fr);
        grid-template-rows: masonry;
      }
      h1, h2 {
        margin: 0 0 0.5em 0;
      }
      body > section {
        padding: 0.5em;
        border: thin solid black;
      }
      ul#ws-output {
        padding: 0;
        list-style: none;
        border: thin solid black;
        display: flex;
        flex-direction: column;
        margin: 0;
        height: 15em;
        overflow-y: scroll;
      }
      ul#ws_output > li {
        padding: 0 0.4em 0.2em;
        font-family: monospace;
      }
      button.displayBtn {
        padding: 0.5em 1em;
        border-radius: 50%;
        width: 3em;
        height: 3em;
        font-weight: bold;
        border: thin solid black;

        color: black;
        background-color: #afa;
        box-shadow: inset -0.1em -0.1em 0.3em 0.1em #222;
      }
      button.displayBtn.pressed {
        color: white;
        background-color: #f55;
        box-shadow: inset 0.1em 0.1em 0.3em 0.1em #222;
      }
      meter#battery-status {
        display: block;
        height: 1.5em;
        width: 100%;
      }
    </style>
    <script>
      var ws;
      const td = new TextDecoder();

      function byte_length_of_field_type(field_type) {
        switch (field_type) {
          case "f32":
            return 4;
          case "i32":
            return 4;
          case "u32":
            return 1;
          case "i8":
            return 1;
          case "u8":
            return 1;
          case "bool":
            return 1;
          default:
            throw new Error('unknown type "' + type_name + '"');
        }
      }
      function reader_for_field_type(field_type) {
        switch (field_type) {
          case "f32":
            return (data_view, byte_offset) =>
              data_view.getFloat32(byte_offset, true);
          case "i32":
            return (data_view, byte_offset) =>
              data_view.getInt32(byte_offset, true);
          case "u32":
            return (data_view, byte_offset) =>
              data_view.getUint32(byte_offset, true);
          case "i8":
            return (data_view, byte_offset) => data_view.getInt8(byte_offset);
          case "u8":
            return (data_view, byte_offset) => data_view.getUint8(byte_offset);
          case "bool":
            return (data_view, byte_offset) =>
              data_view.getInt8(byte_offset) != 0;
          default:
            throw new Error('unknown type "' + type_name + '"');
        }
      }
      function resolve_payload_length(payload_definition) {
        let meta = {
          fields: {},
          total_length: 0,
        };
        for (field_name in payload_definition) {
          const field_type = payload_definition[field_name];
          const field_length = byte_length_of_field_type(field_type);
          meta.fields[field_name] = {
            length: field_length,
            read: reader_for_field_type(field_type),
          };
          meta.total_length += field_length;
        }
        payload_definition.meta = meta;
      }

      const ClientUpdate = {
        ButtonADown: {},
        ButtonAUp: {},
        ButtonBDown: {},
        ButtonBUp: {},
        ButtonMenuDown: {},
        ButtonMenuUp: {},
        JoystickMoved: {
          x: "f32",
          y: "f32",
        },
        BatteryStatusChanged: {
          charge: "u8"
        },
      };
      Object.keys(ClientUpdate).forEach((payload_type_name) => {
        resolve_payload_length(ClientUpdate[payload_type_name]);
      });

      let wsOutput;
      const joystickElements = {};
      const buttonElements = {};
      let batteryElement;
      function init() {
        wsOutput = document.getElementById("ws-output");

        buttonElements.a = document.getElementById("button-a");
        buttonElements.b = document.getElementById("button-b");
        buttonElements.menu = document.getElementById("button-menu");

        joystickElements.sliderX = document.getElementById("joystick-x");
        joystickElements.sliderXValue =
          document.getElementById("joystick-x-value");
        joystickElements.sliderY = document.getElementById("joystick-y");
        joystickElements.sliderYValue =
          document.getElementById("joystick-y-value");
        joystickElements.visualization = document.getElementById(
          "joystick-visualization"
        );

        batteryElement = document.getElementById("battery-status");
      }

      async function connect() {
        console.log("connect");
        ws = new WebSocket("ws://127.0.0.1:9001");
        ws.binaryType = "arraybuffer";
        ws.addEventListener("message", (event) => {
          if (!(event.data instanceof ArrayBuffer)) {
            throw "invalid data type";
          }
          const view = new DataView(event.data);
          const u8arr = new Uint8Array(event.data);
          let position = 0;

          while (position <= u8arr.length - 8) {
            const length = view.getUint32(position, true);
            position += 8;
            const type_name = td.decode(
              u8arr.subarray(position, position + length)
            );
            position += length;

            // console.log(type_name);
            // console.log(
            //   [...u8arr.subarray(position)]
            //   .map(byte => byte.toString(16).padStart(2, "0"))
            // );

            const type = ClientUpdate[type_name];
            if (!type) {
              throw new Error('unknown type "' + type_name + '"');
            }
            const payload = {};
            for (field_name in type.meta.fields) {
              let field_meta = type.meta.fields[field_name];
              payload[field_name] = field_meta.read(view, position);
              position += field_meta.length;
            }
            handle_command(type_name, payload);
          }
        });
      }

      function handle_command(command, payload) {
        let logEntry = document.createElement("li");
        let dateNow = new Date();
        logEntry.textContent = `[${
          dateNow.getHours().toString().padStart(2, "0")
        }:${
          dateNow.getMinutes().toString().padStart(2, "0")
        }:${
          dateNow.getSeconds().toString().padStart(2, "0")
        }] ${command}${JSON.stringify(
          payload
        )}`;
        wsOutput.appendChild(logEntry);
        logEntry.scrollIntoView();

        console.log(command, payload);
        switch (command) {
          case "JoystickMoved":
            joystickElements.sliderX.value = payload.x;
            joystickElements.sliderXValue.value = payload.x.toFixed(4);
            joystickElements.sliderY.value = payload.y;
            joystickElements.sliderYValue.value = payload.y.toFixed(4);
            joystickElements.visualization.setAttribute(
              "cx",
              32.0 + 16.0 * payload.x
            );
            joystickElements.visualization.setAttribute(
              "cy",
              32.0 + 16.0 * payload.y
            );
            break;
          case "ButtonADown":
            buttonElements.a.classList.toggle("pressed", true);
            break;
          case "ButtonAUp":
            buttonElements.a.classList.toggle("pressed", false);
            break;
          case "ButtonBDown":
            buttonElements.b.classList.toggle("pressed", true);
            break;
          case "ButtonBUp":
            buttonElements.b.classList.toggle("pressed", false);
            break;
          case "ButtonMenuDown":
            buttonElements.menu.classList.toggle("pressed", true);
            break;
          case "ButtonMenuUp":
            buttonElements.menu.classList.toggle("pressed", false);
            break;
          case "BatteryStatusChanged":
            batteryElement.value = payload.charge;
            batteryElement.textContent = `${(payload.charge/255.0).toFixed(0)}%`;
            break;
          default:
            console.log("unhandled command", command);
        }
      }

      async function disconnect() {
        console.log("dc");
        ws.close();
      }
    </script>
  </head>
  <body onload="init()">
    <section>
      <section>
        <button onclick="connect()">Connect</button>
        <button onclick="disconnect()">Disconnect</button>
      </section>
      <ul id="ws-output"></ul>
    </section>
    <section>
      <h2>Buttons:</h2>
      <button id="button-a" class="displayBtn" disabled>A</button>
      <button id="button-b" class="displayBtn" disabled>B</button>
      <button id="button-menu" class="displayBtn" disabled>â˜°</button>
    </section>
    <section>
      <h2>Joystick:</h2>
      <section>
        x:
        <input
          id="joystick-x"
          type="range"
          min="-1.0"
          max="1.0"
          step="any"
          value="0.0"
        />
        <input
          id="joystick-x-value"
          type="number"
          readonly
          min="-1.0"
          max="1.0"
          step="any"
          value="0.0"
        />
      </section>
      <section>
        y:
        <input
          id="joystick-y"
          type="range"
          min="-1.0"
          max="1.0"
          step="any"
          value="0.0"
        />
        <input
          id="joystick-y-value"
          type="number"
          readonly
          min="-1.0"
          max="1.0"
          step="any"
          value="0.0"
        />
      </section>
      <svg width="100" height="100" viewBox="0 0 64 64">
        <circle cx="32" cy="32" r="32" fill="lightGray" stroke="black" />
        <circle cx="32" cy="32" r="16" fill="white" stroke="black" />
        <circle
          id="joystick-visualization"
          cx="32"
          cy="32"
          r="16"
          fill="lightGray"
          stroke="black"
        />
      </svg>
    </section>
    <section>
      <h2>Battery</h2>
      <meter id="battery-status"
        min="0"
        max="255"
        low="50"
        high="100"
        optimum="255"
        value="255">
        100%
      </meter>
    </section>
  </body>
</html>
